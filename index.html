<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Spotify Playlist Backup</title>

<script src="config.js"></script>
<script src="auth.js"></script>

<style>
button {
    padding: 12px 20px;
    margin: 10px;
    background: green;
    color: white;
    cursor: pointer;
    border: none;
    font-size: 16px;
}
</style>
</head>

<body>
<h1>Spotify Playlist Backup</h1>
<button onclick="spotifyLogin()">Login with Spotify</button>
<br><br>

<button onclick="exportPlaylists()">Export Playlists</button>
<input type="file" id="importFile">
<button onclick="importPlaylists()">Import Playlists</button>

<script>
async function exportPlaylists() {
    try {
        const token = await getAccessToken();
        if (!token) return alert("Not logged in");

        let all = [];
        let url = "https://api.spotify.com/v1/me/playlists?limit=50";

        while (url) {
            const res = await fetch(url, {
                headers: { Authorization: "Bearer " + token }
            });

            if (!res.ok) throw new Error("Spotify API error: " + res.status);
            const data = await res.json();

            all.push(...data.items);
            url = data.next;
        }

        const blob = new Blob([JSON.stringify(all, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "spotify_backup.json";
        a.click();

    } catch (e) {
        console.error(e);
        alert("Export failed: " + e.message);
    }
}

async function importPlaylists() {
    try {
        const token = await getAccessToken();
        if (!token) return alert("Not logged in");

        const file = document.getElementById("importFile").files[0];
        if (!file) return alert("Choose a file first");

        const text = await file.text();
        const playlists = JSON.parse(text);

        for (const p of playlists) {
            const create = await fetch("https://api.spotify.com/v1/users/me/playlists", {
                method: "POST",
                headers: {
                    Authorization: "Bearer " + token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ name: p.name })
            });

            if (!create.ok) throw new Error("Failed to create playlist: " + create.status);
        }

        alert("Import complete!");
    } catch (e) {
        console.error(e);
        alert("Import failed: " + e.message);
    }
}
</script>

</body>
</html>
