<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SpotMyBackup</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; background: #f6f6f6; margin: 0; padding: 0; }
        .button-main { background: #1DB954; color: white; padding: 10px 20px; border: none; cursor: pointer; font-size: 16px; }
        .button-big { font-size: 18px; padding: 12px 25px; }
        #pnlLoggedOut, #pnlAction { margin: 40px; text-align: center; }
    </style>
</head>
<body>
    <div id="pnlLoggedOut">
        <h1>SpotMyBackup</h1>
        <p>Export your playlists and tracks setup into a file by a single click. Import the file to restore your setup at any time.</p>
        <button id="login" class="button-main button-big">Login with Spotify</button>
    </div>

    <div id="pnlAction" style="display:none;">
        <button id="btnExport" class="button-main">Export Playlists</button>
        <input type="file" id="fileImport">
        <button id="btnImport" class="button-main">Import Playlists</button>
        <div id="importProgress"></div>
    </div>

    <script type="module">
        import { config } from './config.js';
        import { startSpotifyLogin, finishSpotifyLogin, getStoredToken } from './auth.js';

        const loginBtn = document.getElementById('login');
        const pnlLoggedOut = document.getElementById('pnlLoggedOut');
        const pnlAction = document.getElementById('pnlAction');

        async function initApp() {
            const storedToken = getStoredToken();

            // If token exists, show action panel
            if (storedToken) {
                pnlLoggedOut.style.display = 'none';
                pnlAction.style.display = 'block';
                console.log('Spotify token loaded:', storedToken);
            } else {
                // Bind login button
                loginBtn.addEventListener('click', () => startSpotifyLogin(config));
            }

            // Handle redirect after login
            await finishSpotifyLogin(config);

            const token = getStoredToken();
            if (token) {
                pnlLoggedOut.style.display = 'none';
                pnlAction.style.display = 'block';
            }
        }

        initApp();

        // Export button logic
        const btnExport = document.getElementById('btnExport');
        btnExport.addEventListener('click', async () => {
            const token = getStoredToken();
            if (!token) { alert('Not logged in'); return; }

            // Fetch playlists (simplified)
            const resp = await fetch('https://api.spotify.com/v1/me/playlists', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await resp.json();

            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'spotify_backup.json';
            a.click();
        });

        // Import logic (simplified)
        const fileImport = document.getElementById('fileImport');
        const btnImport = document.getElementById('btnImport');
        btnImport.addEventListener('click', () => {
            const file = fileImport.files[0];
            if (!file) { alert('Select a file'); return; }
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = JSON.parse(e.target.result);
                console.log('Imported data:', data);
                // Here you would recreate playlists/tracks using Spotify API
                alert('Import successful (simulated)');
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>
